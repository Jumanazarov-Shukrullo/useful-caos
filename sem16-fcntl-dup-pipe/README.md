


# Копирование файловых дескрипторов и неименованные каналы

<br>
<div style="text-align: right"> 
Спасибо <a href="https://github.com/SyrnikRebirth">Сове Глебу</a> за участие в написании текста     
<br>И я приглашаю всех желающих улучшать материалы
<br>  в этом репозитории, как это можно сделать
<br>  написано в главном README.md 
</div>
<br>


<p><a href="https://www.youtube.com/watch?v=rPv2TKrYGl4&list=PLjzMm8llUm4AmU6i_hPU0NobgA4VsBowc&index=17" target="_blank">
    <h3>Видеозапись семинара</h3> 
</a></p>

[Ридинг Яковлева](https://github.com/victor-yacovlev/mipt-diht-caos/tree/master/practice/fdup-pipe)


Да, dup и pipe мы уже рассматривали в sem13. Так что по этой части будет некоторое повторение (но с большим количеством подробностей).

Сегодня будем рассматривать вызовы:
* `dup`, `dup2`, `dup3` - позволяют "скопировать" файловый дескриптор. То есть получить еще один файловый дескриптор на тот же файл/соединение. Например, так можно скопировать дескриптор файла в 1 файловый дескриптор (stdout) и потом с помощью функции printf писать в этот файл.
  * `dup` - <a href="#dup" style="color:#856024">делает какую-то копию</a>
  * `dup2` - <a href="#dup2" style="color:#856024">делает копию туда, куда вы хотите</a>
  * `dup3` - <a href="#dup3" style="color:#856024">делает купию туда, куда вы хотите + c указанными опциями</a>
* `pipe` - позволяет создать трубу(=pipe) - получить пару файловых дескрипторов. В один из них можно что-то писать, при этом оно будет становиться доступным для чтения из другого дескриптора. Можно рассматривать pipe как своеобразный файл-очередь.
  * `pipe` - <a href="#pipe" style="color:#856024">делает трубу</a>
  * `pipe2` - <a href="#pipe2" style="color:#856024">делает трубу c указанными опциями</a>
* `mkfifo` - позволяет создать именованный канал, по сути пайп, которому соответствует файл в файловой системе. Если открыть этот файл на чтение и на запись, то с полученной парой дескрипторов можно делать то же, что и с пайпом. Главное отличие в том, что именованный канал могут легко открыть неродственные процессы.
  * `mkfifo` - <a href="#mkfifo" style="color:#856024">делает именованную трубу</a>
* `fcntl` - универсальная функция, которая умеет делать с открытыми файлами практически все (TODO):
  * <a href="#fcntl_fd_flags" style="color:#856024">Вытащить / установить флаги файлового дескриптора (узнать, открыт ли дескриптор на запись; выставлен ли O_CLOEXEC)</a>
  * <a href="#fcntl_dup" style="color:#856024">Исползовать вместо dup/dup2.</a>
  * Установить размер буффера для каналов.
  * Различные вещи для совместного доступа к файлам.
  * ...

<a href="#hw" style="color:#856024">Комментарии к ДЗ</a>



```python

```

# dup2

Возможно кто-то из вас видел вызов freopen. Вот это примерно о том же.


```cpp
%%cpp dup2.cpp
%run gcc dup2.cpp -o dup2.exe
%run ./dup2.exe
%run echo "After program finish" && cat out.txt

#include <stdio.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/types.h>


int main() {
    int fd = open("out.txt", O_WRONLY | O_CREAT | O_TRUNC, 0664);
    dup2(fd, 1); // redirect stdout to file
    close(fd);
    printf("Redirectred 'Hello world!'");
    return 0;
}
```


Run: `gcc dup2.cpp -o dup2.exe`



Run: `./dup2.exe`



Run: `echo "After program finish" && cat out.txt`


    After program finish
    Redirectred 'Hello world!'

# dup


```cpp
%%cpp dup.cpp
%run gcc dup.cpp -o dup.exe
%run ./dup.exe

#include <stdio.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/types.h>

int main() {
    int fd = dup(1);  // копируем stdout в другой дескриптор (значение дескриптора выбирается автоматически)
    dprintf(1, "Write to 1 fd.\n");
    dprintf(fd, "Write to %d fd.\n", fd);
    close(1);
    dprintf(fd, "Write to %d fd after closing 1 fd. (still to stdout)\n", fd);
    close(fd);
    return 0;
}
```


Run: `gcc dup.cpp -o dup.exe`



Run: `./dup.exe`


    Write to 1 fd.
    Write to 3 fd.
    Write to 3 fd after closing 1 fd. (still to stdout)



```python

```

## <a name="pipe"></a> pipe и dup2



```cpp
%%cpp pipe.cpp
%run gcc pipe.cpp -o pipe.exe
%run ./pipe.exe

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>

int main() {
    int fd[2];
    pipe(fd); // fd[0] - in, fd[1] - out (like stdin=0, stdout=1)
    pid_t pid_1, pid_2;
    if ((pid_1 = fork()) == 0) {
        dup2(fd[1], 1);
        close(fd[0]); // notice: close file descriptors explicitly
        close(fd[1]); // try to comment out and compare behaviour
        // Даже без закрытия сможет отработать (но не надо так делать, лучше всегда закрывать руками)
        execlp("ps", "ps", "aux", NULL);
        assert(0 && "Unreachable position in code if execlp succeeded");
    }
    if ((pid_2 = fork()) == 0) {
        dup2(fd[0], 0);
        close(fd[0]); // notice: close file descriptors explicitly
        close(fd[1]); // try to comment out and compare behaviour
        // ^^^ tail не завершиться пока открыт файловый дескриптор на запись в pipe (он будет ждать данных, которые он бы смог прочитать)
        execlp("tail", "tail", "-n", "4", NULL);
        assert(0 && "Unreachable position in code if execlp succeeded");
    }
    close(fd[0]); // Тут закрыли pipe, потому что он нам больше не нужен (и потому что, если не закроем, то будет ошибка как с программой tail)
    close(fd[1]);
    int status;
    assert(waitpid(pid_1, &status, 0) != -1); // [1.]
    assert(waitpid(pid_2, &status, 0) != -1);
    return 0;
}
```


Run: `gcc pipe.cpp -o pipe.exe`



Run: `./pipe.exe`


    pechatn+   26228  0.0  0.0   2608   536 pts/3    Ss+  11:36   0:00 /usr/bin/sh -c ./pipe.exe
    pechatn+   26229  0.0  0.0   2356   576 pts/3    S+   11:36   0:00 ./pipe.exe
    pechatn+   26230  0.0  0.1  20124  3308 pts/3    R+   11:36   0:00 ps aux
    pechatn+   26231  0.0  0.0  16748   584 pts/3    S+   11:36   0:00 tail -n 4


1. Вопрос: почему нужно делать waitpid после close?
  <br> Ответ: потому что у нас остаётся открытый файловый дескриптор. Дочерний процесс не завершится до тех пор, пока не закроется пайп на запись. А пайп на запись не закроется, пока не закроются все соответствующие файловые дескрипторы (и не только в том же самом процессе). Соответственно, если не сделать close до waitpid, то он просто зависнет. 


```python

```

# <a name="pipe2"></a> pipe2 и dup2


```cpp
%%cpp pipe2.cpp
%run gcc pipe2.cpp -o pipe2.exe
%run ./pipe2.exe

#ifndef _GNU_SOURCE
  #define _GNU_SOURCE
#endif
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>

int main() {
    int fd[2];
    pipe2(fd, O_CLOEXEC); // O_CLOEXEC - created file descriptors will be closed on exec call
    pid_t pid_1, pid_2;
    if ((pid_1 = fork()) == 0) {
        dup2(fd[1], 1); // dup2 doesn't copy O_CLOEXEC attribute
        //dup3(fd[1], 1, O_CLOEXEC); // can compare with this
        execlp("ps", "ps", "aux", NULL);
        assert(0 && "Unreachable position in code if execlp succeeded");
    }
    if ((pid_2 = fork()) == 0) {
        // no close calls here
        dup2(fd[0], 0);
        execlp("tail", "tail", "-n", "4", NULL);
        assert(0 && "Unreachable position in code if execlp succeeded");
    }
    close(fd[0]);
    close(fd[1]);
    int status;
    assert(waitpid(pid_1, &status, 0) != -1);
    assert(waitpid(pid_2, &status, 0) != -1);
    return 0;
}
```


Run: `gcc pipe2.cpp -o pipe2.exe`



Run: `./pipe2.exe`


    pechatn+   26260  0.0  0.0   2608   604 pts/3    Ss+  11:40   0:00 /usr/bin/sh -c ./pipe2.exe
    pechatn+   26261  0.0  0.0   2356   516 pts/3    S+   11:40   0:00 ./pipe2.exe
    pechatn+   26262  0.0  0.1  20124  3352 pts/3    R+   11:40   0:00 ps aux
    pechatn+   26263  0.0  0.0  16748   584 pts/3    S+   11:40   0:00 tail -n 4


Этот пример работал в том числе благодаря тому, что dup2 не копирует O_CLOEXEC флаг. 
Если же вам по каким-то причинам будет нужно, чтобы он копировался, 
то можно исползовать `dup3(fd[1], 1, O_CLOEXEC)`. <a name="dup3"></a>


```python

```

# <a name="fcntl_dup"></a> fcntl: вместо dup

Варианты использования fcntl для получения и изменения флагов файловых дескрипторов разбирали в sem11.


```cpp
%%cpp fcntl_dup.cpp
%run gcc fcntl_dup.cpp -o fcntl_dup.exe
%run ./fcntl_dup.exe
%run echo "After program finish" && cat out.txt
%run diff dup2.cpp fcntl_dup.cpp  | grep -v "// %" | grep -e '>' -e '<' -C 1

#include <stdio.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/types.h>


int main() {
    int fd = open("out.txt", O_WRONLY | O_CREAT | O_TRUNC, 0664);
    close(1); // important (в следующей функции просим сделать дескриптор >= 1, поэтому тут нужно закрыть дескриптор 1, чтобы он стал доступен)
    int fd_copy = fcntl(fd, F_DUPFD, 1);
    assert(fd_copy == 1);
    // Три строчки сверху выполняют то же что и dup2(fd, 1)
    // Но не совсем, подумайте, почему не могут быть эквивалентны?
    close(fd);
    printf("Redirectred 'Hello world!'");
    return 0;
}
```


Run: `gcc fcntl_dup.cpp -o fcntl_dup.exe`



Run: `./fcntl_dup.exe`



Run: `echo "After program finish" && cat out.txt`


    After program finish
    Redirectred 'Hello world!'


Run: `diff dup2.cpp fcntl_dup.cpp  | grep -v "// %" | grep -e '>' -e '<' -C 1`


    15c16,20
    <     dup2(fd, 1); // redirect stdout to file
    ---
    >     close(1); // important (в следующей функции просим сделать дескриптор >= 1, поэтому тут нужно закрыть дескриптор 1, чтобы он стал доступен)
    >     int fd_copy = fcntl(fd, F_DUPFD, 1);
    >     assert(fd_copy == 1);
    >     // Три строчки сверху выполняют то же что и dup2(fd, 1)
    >     // Но не совсем, подумайте, почему не могут быть эквивалентны?



```python

```

# fcntl: O_NONBLOCK


```cpp
%%cpp pipe2.cpp
%run gcc pipe2.cpp -o pipe2.exe
%run ./pipe2.exe

#ifndef _GNU_SOURCE
  #define _GNU_SOURCE
#endif
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <sched.h>
#include <time.h>
#include <errno.h>

int main() {
    int fd[2];
    pipe(fd); 
    pid_t pid_1, pid_2;
    if ((pid_1 = fork()) == 0) {
        dup2(fd[1], 1); 
        close(fd[0]); 
        close(fd[1]);
        for (int i = 0; i < 1000; ++i) {
            write(1, "X", 1);
            //sched_yield();
            struct timespec t = {.tv_sec = 0, .tv_nsec = 10000};
            nanosleep(&t, &t);  
        }
        return 0;
    }
    if ((pid_2 = fork()) == 0) {
        // no close calls here
        dup2(fd[0], 0);
        close(fd[0]); 
        close(fd[1]);
        fcntl(0, F_SETFL, fcntl(0, F_GETFL, 0) | O_NONBLOCK);
        while (true) {
            char c;
            int r = read(0, &c, 1);
            if (r > 0) {
                write(1, &c, 1);
            } else if (r < 0) {
                assert(errno == EAGAIN);
                write(1, "?", 1);
            } else {
                break;
            }
        }
        return 0;
    }
    close(fd[0]);
    close(fd[1]);
    int status;
    assert(waitpid(pid_1, &status, 0) != -1);
    assert(waitpid(pid_2, &status, 0) != -1);
    return 0;
}
```


Run: `gcc pipe2.cpp -o pipe2.exe`



Run: `./pipe2.exe`


    XX???????????????????????????????X??????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????X????????????????X???????????????????????????X????????????????????????????????????????????????????????????????????????X???????????????????X??????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????XX?????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????X??????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????X??????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????X??????????????????????????????????????????????X????????????????????????????????????????????????????????????X???????????????????????????????????X???????????????????????????????????X?????????????????????????X??????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????X????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????X????????????????????????????????????????????????????????X??????????????????????X?????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????X?????????????X??????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????X?????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X??????????????????????????????????????????????X????????????????????????????????????????????X??????????????????????????????????????????X???????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????X????????????X?????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????X????????X????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????X?????????????????????X???????????????????????????????????????????????????????????????????????X????????????????????????????X?????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????X???????????????????????????????????????????????????????????????X?????????X???????X???????????????????????????XX???????????????????????????????????????X????????????X?????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X??????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????X????????????????????X??????????????????????????????????X???????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X??????????????????X???????????????X??X???????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????X??????????????????????????????X???????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????X????????????????X????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X?????????X???????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????X???????????X???????????????????????????????????????????????????????X?????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????X??????????????????X?????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????X???????????????X?????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X??????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????X?????????X??????????????????????????????????????????????????????????X????????X?????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????X????????????????????XX????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????X?????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X??????????????????????????????????????????X??????????????????????????????????????????????????????????????X????????????????????????????????????????????????X??????????????????????X?????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????X???????????????????????????????X???????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X???????????X??????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X???????????XXX???????????????????????????????????????????????????????X?????????????????????????????????????????????????XX??X?????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????XX????????????????????????????????????????X?????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X??????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????XX????????????????????????????????X???????????????????????????????????????????????????????????????????????????X????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????XX??????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????X??????????????????X??????X????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X???????????????????X???????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X??????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????X??????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????X???????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X????????????????????XX??????????????????????????????????????????????X???????????????????????????????X????????????????????X??????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X?????????????????????????????????????????X????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X??????X????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X??????????????????????????????X???????????????????????????????X???????????????????????????????????????X??????????????????????????????X??????????????????????????????X?????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????X?????X??????????????X????????????????????????????????????????????????X??????????????????X???????X??????????????????????????????????????????X?????????????????????????????????????????????X???????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????X??????????????????X????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X??????????????X???????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????X????????????????????????????????????????????????????????????????????????X???????????????????????????????????????X??????????????????????????????????????????????????????????????????????X?????????????X???????????????????????????????????????????????????????????????????X??????????????????????????????????????????????XX????????????????????X????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X?????????????????????????????????X????????????????????????????????????????????X???????????????????????X????????????????????????????????????????X????????????????????????????????????????X????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????X??????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X?????????????????????????????X??????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X??????????X??????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X??????????????????????X?????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X????????????X?????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????X?????????????????????????X????????????????????????????????????????X????????????????????????????????????????X????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????X?????????????????????????????X?????????????????????????????????X?????????????????????????????????????????????????????????????X??????????????????????????????????????????????????X??????????????????????????????X???????????????????????X??X???????????????????????????????????????????????????X??????????????????????????????????????????????????X???????????????X???????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????X????????????????????????????????????????????????X????X???????????????????????????????????????????????????????????????????????????????????????X???????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????X??????????????????????????????????????????????????????????X???????????????????????????????????????????????X???????????????????????????????????????????X????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????X???????X??????????????????????????????????????????????????????????????????XX??????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X??????X??????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????X??????????????????????????????????????X???????????????????????????????????????????????X????????????????????????????????????????X????????X??????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X???????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X????????????????????????????????????????X?????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X??X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????XX????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????X????????????X?????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X?????????????????????????X??????????????????????????????????????????????X??X??????????????????????????X?????????????????????????????????????????????????????????????????????????X???????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????X??????????????????????????????????????????????????X?????????????????????????????????????????X???????????????????X?????????????????????????????????????????????????????????X?X???????????????????????????????????????????????????????????X????????????????????X????????????????????????????????????????????????????????????X???????????????????????????????????????X??????????????????????????????????????????????????????????X????????????????????????????????????????????????????????X??????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????X??????????????????????????????????????XX?????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????X?????????????X????????????????????????????????????????????????????????X??????????????????????????????????????????????????XXXX?????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????X???????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X??????????X???????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X???????????????????????????????????XX??????????????????????????????X???????????????????????????????????????????????????????????????????????????X??????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????X????????????????????????????????????X?????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????X?????X????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X??XXXX?????????????????????????????X????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X??????X??????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????X???????????????X???????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X?X????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X?????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????X???????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????X??????????X????????????????????????X??????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????X?????????????????????????????????????????????????XX?????X?????????????????????????????????????????????????????????????????????????XX??????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X???????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????XX???????????????????????????????????????????????????????X????????????????????????????????????????????????X???????????????X?????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????X???????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X???????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????X?????????????????????X????????????????????????????????XX???????????????????????????????X????????????????????????????????????X??????X??????????????????????????????????????????????????????X??????????????????????????????????????????????????X????????????????????????????????????????????????X???????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????X??????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????X???????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????X???????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X???????????????????????????????X?????????????????????????????????????????????????????X?????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????X????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X?????????????????X?????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????X?????????????X???????????????X???????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????X??????X????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????X?????????????????????????????????????????????????????X??????????????????????????????????????????????????????X??????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????X??????????????????X?????????????????????????????X??????????????????????????????????????????????????????????????????X???????????X?????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????X?????????????????????????????????????????????????????????????X???????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X?????????????????????????????????????????X??????????????????????????????????????????????X???????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X?????????????????????????????????????????X?????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????X?????????X??????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????XX??????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????X?????????????????????????????????????????????X???????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X????????????????????????????X??????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????XX?????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????X???????????????????????????????????????????????X??????????????????????????????X????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????XX????????????????X???????????????????????????????????????X??????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X?????????????????????X???????????????????????????????????????????X?????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????X???????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????X????????????????????????????????????????????????????????X????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????X???????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????X???????????????????????????????????????????????X???????????????????????????X???????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????XX????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????X?????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????X???????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????X?????????????????????X????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X??????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????X????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????XX??????????????????????????????????????????????????????????????????X??????????????????X???????????????????????????????????????????????????????????????????????????X??????????????????????X????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????X???????????????????????????????X??????????????X??????????????????????????????????????????????????????????????????X??????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????X????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????X??????????????????????????X??????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????X????????????????????????????X????????????????????????????X??????????????????????????????????????X???????????????????????????????????????????????????????????????XX???????????????????????????????????????X???????????????????????X?????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????X??????????????????????????????????X???????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????X??????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????X????????????????????????????????????????????????????????X??????X???????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????X???????????????????????????????X?????????????????????????X?????????????????????????????????X?????????????????????X????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X?????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????X???????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X????????????X??????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????X??????????X??????????????????????????????????????X?????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????X??????????????????????????????X??????????????????????????????????????X?????????????????????????????????????????????????????????X????????????????????????????X???????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X?????????????????????????X???????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????X???????????????????X?????????????????????????????????????X????????????????????????????????????X??????????????????????????????????X???????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????X??????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????X??????????????????????????????????????????????????????????????????????X???????????????????????????????????????????????????X?????????????????????????????????????????????????????????????????????????????X????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????


```python

```

# pipe: Эксперимент с вмесимостью


```cpp
%%cpp pipe_buff.cpp
%run gcc pipe_buff.cpp -o pipe_buff.exe
%run timeout 1 ./pipe_buff.exe 1000 && echo SUCCESS || echo FAILED
%run timeout 1 ./pipe_buff.exe 10000 && echo SUCCESS || echo FAILED
%run timeout 1 ./pipe_buff.exe 100000 && echo SUCCESS || echo FAILED

#ifndef _GNU_SOURCE
  #define _GNU_SOURCE
#endif
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <sched.h>
#include <time.h>
#include <errno.h>

int main(int argc, char** argv) {
    assert(argc == 2);
    int size = strtol(argv[1], NULL, 10);
    int fd[2];
    pipe2(fd, O_NONBLOCK); // try to comment and compare
    char* data = (char*)calloc(size, sizeof(char));
    
    printf("Start writing %d bytes %p\n", size, data);
    int written = write(fd[1], data, size);
    if (written != size) {
        printf("Write only %d bytes\n", written);
    } else {
        printf("Written %d bytes\n", written);
        assert(read(fd[0], data, size) == size);
    }
    
    free(data);
    
    close(fd[0]);
    close(fd[1]);
    return (written == size) ? 0 : -1;
}
```


Run: `gcc pipe_buff.cpp -o pipe_buff.exe`



Run: `timeout 1 ./pipe_buff.exe 1000 && echo SUCCESS || echo FAILED`


    Start writing 1000 bytes 0x56534cec82a0
    Written 1000 bytes
    SUCCESS



Run: `timeout 1 ./pipe_buff.exe 10000 && echo SUCCESS || echo FAILED`


    Start writing 10000 bytes 0x55f60a0862a0
    Written 10000 bytes
    SUCCESS



Run: `timeout 1 ./pipe_buff.exe 100000 && echo SUCCESS || echo FAILED`


    Start writing 100000 bytes 0x55e95dc102a0
    Write only 65536 bytes
    FAILED



```python

```

# pipe: Ошибка записи из-за того, что данные некому читать


```cpp
%%cpp pipe_err.c
%run gcc pipe_err.c -o pipe_err.exe
%run ./pipe_err.exe ; echo  "Exit code is $?"

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <sched.h>
#include <time.h>
#include <errno.h>
#include <signal.h>
    
int main() {
    signal(SIGPIPE, SIG_IGN); // форсим дефолтное поведение, так как тут наследуется маска сигналов питона
    
    int size = 100000;
    int fd[2];
    pipe(fd); 

    close(fd[0]);
    char* data = (char*)calloc(size, sizeof(char));
    
    int ret = write(fd[1], data, size);
    if (ret == size) {
        printf("OK\n");
    } else {
        printf("ret = %d\n", ret);
        perror("FAILED to write");
    }
    
    free(data);
    
    int status;
    
    close(fd[1]);
    return 0;
}
```


Run: `gcc pipe_err.c -o pipe_err.exe`



Run: `./pipe_err.exe ; echo  "Exit code is $?"`


    ret = -1
    FAILED to write: Broken pipe
    Exit code is 0


141 > 128 -> убит сигналом SIGPIPE = 13 = 141 - 128

То, на что я убил час: если программа запускается питоном, то она игнорит SIGPIPE 

```
[22:33:00 янв 30] pechatnov@pechatnov-vbox:~
  -> (cat ; echo "code $?" 1>&2) | head

code 141
Killed
[22:35:27 янв 30] pechatnov@pechatnov-vbox:~
  -> python3 -c "import os; os.system('(cat ; echo \"code \$?\" 1>&2)')" | head

cat: write error: Broken pipe
code 1
Killed
```

(head килляется вручную и затем пишется перевод строки на вход в обоих случаях)


```python

```

# mkfifo

Из man 3 mkfifo
```
A  FIFO  special  file is similar to a pipe, except that it is created in a
different way.  Instead of being an  anonymous  communications  channel,  a
FIFO special file is entered into the filesystem by calling mkfifo().

Once you have created a FIFO special file in this way, any process can open
it for reading or writing, in the same way as an ordinary  file.   However,
it  has to be open at both ends simultaneously before you can proceed to do
any input or output operations on it.  Opening a FIFO for reading  normally
blocks  until  some other process opens the same FIFO for writing, and vice
versa.  See fifo(7) for nonblocking handling of FIFO special files.
```


```cpp
%%cpp fifo.cpp
%run gcc fifo.cpp -o fifo.exe
%run rm -f ./my_fifo
%run ./fifo.exe

#ifndef _GNU_SOURCE
  #define _GNU_SOURCE
#endif
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/resource.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <string.h>
#include <time.h>
#include <errno.h>

int main() {
    // Создадим два ничего не знающих друг о друге процесса
    pid_t pid_1, pid_2;
    if ((pid_1 = fork()) == 0) {
        assert(mkfifo("./my_fifo", 0644) == 0); // создаем fifo
        int fd = open("./my_fifo", O_WRONLY); // открыли fifo на запись
        assert(fd >= 0);
        char data[] = "World is just world";
        assert(write(fd, &data, strlen(data)) == strlen(data));
        close(fd);
        return 0;
    }
    if ((pid_2 = fork()) == 0) {
        int fd = -1;
        while (true) {
            fd = open("./my_fifo", O_RDONLY); // пытаемся открыть fifo
            if (fd >= 0) {
                break;
            }
            fprintf(stderr, "Failed to open fifo. Try again\n");
            struct timespec t = {.tv_sec = 0, .tv_nsec = 10000000}; // 10ms
            nanosleep(&t, &t);  
        }
        // fd - отрытый на чтение конец fifo
        int size = 0;
        char buf[100];
        // читаем из fifo и пишем прочитанное в stdout
        while ((size = read(fd, buf, sizeof(buf))) > 0) {
            assert(write(1, buf, size) == size);
        }
        assert(size == 0); // проверяем "конец файла"
        close(fd);
        return 0;
    }
    int status;
    assert(waitpid(pid_1, &status, 0) != -1);
    assert(waitpid(pid_2, &status, 0) != -1);
    return 0;
}
```


Run: `gcc fifo.cpp -o fifo.exe`



Run: `rm -f ./my_fifo`



Run: `./fifo.exe`


    World is just world


```python

```


```python

```


```python

```

# <a name="hw"></a> Комментарии к ДЗ

* `posix/pipe/launch` - фактически разобрана, когда переизобретали `freopen`.
* `posix/pipe/connect-2-processes` - тоже фактически разобрана. pipe + работа с дочерними процессами. Для тестирования может быть удобно написать свои программки в виде скриптов с шебангом. [Ссылка для студентов с плохой памятью](https://andreyex.ru/operacionnaya-sistema-linux/shebang-v-bash)
* `posix/pipe/process-gcc-output-2` - как предыдущая, но нужно самим написать программы по разные стороны pipe. Разрешаю использовать `python -c` (типа `python -c 'print "abacaba\nasdfdsv".find("aca")'`)
* `posix/pipe/connect-n-processes` - просто обобщить предыдущую задачу
* `posix/pipe/connect-n-processes-one-pipe`
  * В этой задаче важно не забывать про изначально открытые файловые дескрипторы.
  * Когда вы делаете fork и запускается новая программа, она может подгружать динамические библиотеки. И при этом могут создаваться и закрываться файловые дескрипотры. Так что, если у вас открыто 8 файловых дескрипторов, то на fork'е вы скорее всего сломаетесь.
  * Разрешаю хранить промежуточный вывод подпрограмм в памяти основного процесса.
  * В этой задаче можно немного упороться и обойтись двумя пайпами за все время существования программы. Для этого, нужно предполагать, что программы-команды не будут ретраить операцию чтения в случае ошибок. Дальше просто применяем O_NONBLOCK.

**Замечание**

Конечно, однострочники питона это очень плохо в продакшн коде, но очень полезный навык для администрирования всякого-разного.

В качестве простого примера, допустим, что вам нужно красиво отрисовать json и у вас нет для этого встроенных средств:

```bash
[00:44:00 фев 09] pechatnov@pechatnov-osx2:~
  -> echo '{"a": "b", "d": [1, 2, 3]}' | python -c 'import json, sys; json.dump(json.load(sys.stdin), sys.stdout, indent=4)'
{
    "a": "b",
    "d": [
        1,
        2,
        3
    ]
}
```

Тут же можно пофильтровать этот json по какому либо признаку.

В однострочниках есть сложности с циклами и ветвлением, но часто легко обойтись генераторами списков и "тернарными" if'ами.

Так же можно создать файл со скриптом через vim/nano, кто-нибудь из них обычно есть в качестве встроенного редактора.


```python

```


```python

```


```python

```
